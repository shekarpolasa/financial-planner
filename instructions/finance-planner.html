<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WealthPlan Pro - Advanced Financial Planning</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px auto;
            max-width: 1400px;
            overflow: hidden;
        }
        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 15px 25px;
            transition: all 0.3s ease;
        }
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .card-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px 15px 0 0 !important;
            border: none;
            padding: 20px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 10px 25px;
            font-weight: 500;
            transition: transform 0.2s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            transition: border-color 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .result-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
        }
        .expense-item, .investment-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        .delete-btn {
            background: #dc3545;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            color: white;
            font-size: 12px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .summary-card {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        .warning-card {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }
        .danger-card {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }
        .info-card {
            background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
        }
        .inflation-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        .net-worth-display {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
        }
        .progress-custom {
            height: 10px;
            border-radius: 10px;
            background: rgba(255,255,255,0.3);
        }
        .progress-bar-custom {
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Enhanced utility functions with inflation
        const calculateSIP = (monthlyAmount, annualRate, years) => {
            const monthlyRate = annualRate / 12 / 100;
            const months = years * 12;
            const futureValue = monthlyAmount * (((Math.pow(1 + monthlyRate, months) - 1) / monthlyRate) * (1 + monthlyRate));
            return futureValue;
        };

        const calculateLumpsum = (amount, annualRate, years) => {
            return amount * Math.pow(1 + annualRate / 100, years);
        };

        const calculateEMI = (principal, annualRate, years) => {
            const monthlyRate = annualRate / 12 / 100;
            const months = years * 12;
            const emi = principal * monthlyRate * Math.pow(1 + monthlyRate, months) / (Math.pow(1 + monthlyRate, months) - 1);
            return emi;
        };

        const calculateInflationAdjustedExpense = (currentExpense, inflationRate, years) => {
            return currentExpense * Math.pow(1 + inflationRate / 100, years);
        };

        const calculateSWPWithInflation = (totalAmount, monthlyWithdrawal, annualRate, inflationRate) => {
            const monthlyRate = annualRate / 12 / 100;
            const monthlyInflationRate = inflationRate / 12 / 100;
            let balance = totalAmount;
            let currentWithdrawal = monthlyWithdrawal;
            let months = 0;
            while (balance > currentWithdrawal && months < 600) { // Max 50 years
                balance = balance * (1 + monthlyRate) - currentWithdrawal;
            }
            return months;
        };

        // IncomeTab component for Income tab with retirement age option
        function IncomeTab({ data, setData, addIncome, deleteItem }) {
            const [incomeForm, setIncomeForm] = React.useState({
                name: '',
                amount: '',
                type: 'Monthly',
                retirementAge: ''
            });
            const [editingId, setEditingId] = React.useState(null);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (editingId) {
                    setData(prev => ({
                        ...prev,
                        incomes: prev.incomes.map(inc => inc.id === editingId ? { ...incomeForm, id: editingId } : inc)
                    }));
                    setEditingId(null);
                } else {
                    addIncome(incomeForm);
                }
                setIncomeForm({ name: '', amount: '', type: 'Monthly', retirementAge: '' });
            };

            const startEdit = (income) => {
                setIncomeForm(income);
                setEditingId(income.id);
            };

            const cancelEdit = () => {
                setIncomeForm({ name: '', amount: '', type: 'Monthly', retirementAge: '' });
                setEditingId(null);
            };

            return (
                <div className="row">
                    <div className="col-md-6">
                        <div className="card">
                            <div className="card-header">
                                <h5><i className="fas fa-plus me-2"></i>{editingId ? 'Edit Income' : 'Add Income'}</h5>
                            </div>
                            <div className="card-body">
                                <form onSubmit={handleSubmit}>
                                    <div className="mb-3">
                                        <label className="form-label">Income Name</label>
                                        <input
                                            type="text"
                                            className="form-control"
                                            value={incomeForm.name}
                                            onChange={e => setIncomeForm(prev => ({ ...prev, name: e.target.value }))}
                                            placeholder="e.g., Salary, Pension, Rental"
                                            required
                                        />
                                    </div>
                                    <div className="mb-3">
                                        <label className="form-label">Amount (₹)</label>
                                        <input
                                            type="number"
                                            className="form-control"
                                            value={incomeForm.amount}
                                            onChange={e => setIncomeForm(prev => ({ ...prev, amount: e.target.value }))}
                                            required
                                        />
                                    </div>
                                    <div className="mb-3">
                                        <label className="form-label">Type</label>
                                        <select
                                            className="form-select"
                                            value={incomeForm.type}
                                            onChange={e => setIncomeForm(prev => ({ ...prev, type: e.target.value }))}
                                        >
                                            <option value="Monthly">Monthly</option>
                                            <option value="Annual">Annual</option>
                                        </select>
                                    </div>
                                    <div className="mb-3">
                                        <label className="form-label">Retirement Age</label>
                                        <input
                                            type="number"
                                            className="form-control"
                                            value={incomeForm.retirementAge}
                                            onChange={e => setIncomeForm(prev => ({ ...prev, retirementAge: e.target.value }))}
                                            required
                                        />
                                    </div>
                                    <button type="submit" className="btn btn-primary me-2">{editingId ? 'Update' : 'Add'}</button>
                                    {editingId && <button type="button" className="btn btn-secondary" onClick={cancelEdit}>Cancel</button>}
                                </form>
                            </div>
                        </div>
                    </div>
                    <div className="col-md-6">
                        <div className="card">
                            <div className="card-header">
                                <h5>Income List</h5>
                            </div>
                            <div className="card-body">
                                <ul className="list-group">
                                    {data.incomes && data.incomes.map(income => (
                                        <li key={income.id} className="list-group-item d-flex justify-content-between align-items-center">
                                            <span>{income.name} - ₹{income.amount} ({income.type}) {income.retirementAge && `Retires at ${income.retirementAge}`}</span>
                                            <span>
                                                <button className="btn btn-sm btn-info me-2" onClick={() => startEdit(income)}>Edit</button>
                                                <button className="btn btn-sm btn-danger" onClick={() => deleteItem('incomes', income.id)}>Delete</button>
                                            </span>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const calculateNetWorth = (data) => {
            let totalAssets = data.cash;
            
            // Add current value of investments (not future value)
            data.investments.forEach(inv => {
                if (inv.type === 'SIP') {
                    // For SIP, calculate current accumulated value
                    totalAssets += parseFloat(inv.monthlyAmount) * 12 * parseFloat(inv.yearsInvested || 0);
                } else {
                    totalAssets += parseFloat(inv.amount);
                }
            });

            // Subtract liabilities
            let totalLiabilities = 0;
            data.liabilities.forEach(liability => {
                totalLiabilities += parseFloat(liability.principal);
            });

            return totalAssets - totalLiabilities;
        };

        function FinancialGraph({ data, swpPlan }) {
            const [chartType, setChartType] = useState('outflow');
            
            if (!swpPlan) return null;
            
            const years = Array.from({length: 30}, (_, i) => i);
            
            const generateGraphData = () => {
                return years.map(year => {
                    // Investment growth (corpus value after withdrawals)
                    let investmentGrowth = data.cash || 0;
                    
                    if (data.investments && data.investments.length > 0) {
                        data.investments.forEach(inv => {
                            if (year <= parseFloat(inv.years || 0)) {
                                if (inv.type === 'SIP') {
                                    investmentGrowth += calculateSIP(parseFloat(inv.monthlyAmount || 0), parseFloat(inv.expectedReturn || 0), year);
                                } else {
                                    investmentGrowth += calculateLumpsum(parseFloat(inv.amount || 0), parseFloat(inv.expectedReturn || 0), year);
                                }
                            } else {
                                // After investment period, calculate final value and growth
                                if (inv.type === 'SIP') {
                                    const finalValue = calculateSIP(parseFloat(inv.monthlyAmount || 0), parseFloat(inv.expectedReturn || 0), parseFloat(inv.years || 0));
                                    investmentGrowth += finalValue * Math.pow(1 + (data.postRetirementReturn || 8) / 100, year - parseFloat(inv.years || 0));
                                } else {
                                    const finalValue = calculateLumpsum(parseFloat(inv.amount || 0), parseFloat(inv.expectedReturn || 0), parseFloat(inv.years || 0));
                                    investmentGrowth += finalValue * Math.pow(1 + (data.postRetirementReturn || 8) / 100, year - parseFloat(inv.years || 0));
                                }
                            }
                        });
                    }

                    // Expenses withdrawn per year - only after SWP starts
                    let expensesWithdrawn = 0;
                    if (year >= swpPlan.yearsToSwpStart) {
                        const currentExpenses = swpPlan.currentMonthlyExpenses * 12;
                        expensesWithdrawn = calculateInflationAdjustedExpense(currentExpenses, data.inflationRate || 6, year - swpPlan.yearsToSwpStart);
                    }
                    
                    // EMI payments per year - only after SWP starts AND while loans are still active
                    let emiPayments = 0;
                    if (year >= swpPlan.yearsToSwpStart && data.liabilities && data.liabilities.length > 0) {
                        data.liabilities.forEach(liability => {
                            if (year < parseFloat(liability.years || 0)) {
                                const monthlyEMI = calculateEMI(parseFloat(liability.principal || 0), parseFloat(liability.interestRate || 0), parseFloat(liability.years || 0));
                                emiPayments += monthlyEMI * 12;
                            }
                        });
                    }

                    // Adjust investment growth by subtracting withdrawals after SWP starts
                    if (year >= swpPlan.yearsToSwpStart) {
                        const yearsAfterSwp = year - swpPlan.yearsToSwpStart;
                        let cumulativeWithdrawals = 0;
                        
                        // Calculate cumulative withdrawals with inflation
                        for (let i = 0; i <= yearsAfterSwp; i++) {
                            const yearlyExpenses = calculateInflationAdjustedExpense(swpPlan.currentMonthlyExpenses * 12, data.inflationRate || 6, i);
                            cumulativeWithdrawals += yearlyExpenses;
                        }
                        
                        investmentGrowth = Math.max(0, investmentGrowth - cumulativeWithdrawals);
                    }

                    return {
                        year,
                        investmentGrowth: Math.max(0, investmentGrowth),
                        expensesWithdrawn,
                        emiPayments,
                        totalOutflow: expensesWithdrawn + emiPayments
                    };
                });
            };

            const graphData = generateGraphData();
            
            // Generate Year-over-Year data for the new chart
            const generateYoYData = () => {
                return years.map(year => {
                    // Calculate corpus value at start of year (before withdrawals)
                    let corpusStartOfYear = data.cash || 0;
                    
                    if (data.investments && data.investments.length > 0) {
                        data.investments.forEach(inv => {
                            if (year <= parseFloat(inv.years || 0)) {
                                if (inv.type === 'SIP') {
                                    corpusStartOfYear += calculateSIP(parseFloat(inv.monthlyAmount || 0), parseFloat(inv.expectedReturn || 0), year);
                                } else {
                                    corpusStartOfYear += calculateLumpsum(parseFloat(inv.amount || 0), parseFloat(inv.expectedReturn || 0), year);
                                }
                            } else {
                                if (inv.type === 'SIP') {
                                    const finalValue = calculateSIP(parseFloat(inv.monthlyAmount || 0), parseFloat(inv.expectedReturn || 0), parseFloat(inv.years || 0));
                                    corpusStartOfYear += finalValue * Math.pow(1 + (data.postRetirementReturn || 8) / 100, year - parseFloat(inv.years || 0));
                                } else {
                                    const finalValue = calculateLumpsum(parseFloat(inv.amount || 0), parseFloat(inv.expectedReturn || 0), parseFloat(inv.years || 0));
                                    corpusStartOfYear += finalValue * Math.pow(1 + (data.postRetirementReturn || 8) / 100, year - parseFloat(inv.years || 0));
                                }
                            }
                        });
                    }
                    
                    // Subtract cumulative withdrawals up to previous year
                    if (year > swpPlan.yearsToSwpStart) {
                        let cumulativeWithdrawals = 0;
                        for (let i = 0; i < year - swpPlan.yearsToSwpStart; i++) {
                            const yearlyExpenses = calculateInflationAdjustedExpense(swpPlan.currentMonthlyExpenses * 12, data.inflationRate || 6, i);
                            cumulativeWithdrawals += yearlyExpenses;
                        }
                        corpusStartOfYear = Math.max(0, corpusStartOfYear - cumulativeWithdrawals);
                    }
                    
                    // Annual growth = corpus growth rate applied to start-of-year corpus
                    let annualGrowth = 0;
                    if (year >= swpPlan.yearsToSwpStart && corpusStartOfYear > 0) {
                        annualGrowth = corpusStartOfYear * (data.postRetirementReturn || 8) / 100;
                    } else if (year < swpPlan.yearsToSwpStart) {
                        // During accumulation phase, growth is from new investments
                        if (data.investments && data.investments.length > 0) {
                            data.investments.forEach(inv => {
                                if (year < parseFloat(inv.years || 0)) {
                                    if (inv.type === 'SIP') {
                                        // Annual SIP contribution
                                        annualGrowth += parseFloat(inv.monthlyAmount || 0) * 12;
                                    }
                                    // For lumpsum, growth is already calculated in corpus
                                }
                            });
                        }
                    }
                    
                    // Annual withdrawals (only after SWP starts)
                    let annualWithdrawals = 0;
                    if (year >= swpPlan.yearsToSwpStart) {
                        const currentExpenses = swpPlan.currentMonthlyExpenses * 12;
                        annualWithdrawals = calculateInflationAdjustedExpense(currentExpenses, data.inflationRate || 6, year - swpPlan.yearsToSwpStart);
                    }
                    
                    // Net change (growth - withdrawals)
                    const netChange = annualGrowth - annualWithdrawals;
                    
                    return {
                        year,
                        annualGrowth,
                        annualWithdrawals,
                        netChange,
                        corpusStartOfYear
                    };
                });
            };
            
            const yoyData = generateYoYData();
            const maxValue = chartType === 'outflow' 
                ? Math.max(...graphData.map(d => Math.max(d.totalOutflow, d.expensesWithdrawn, d.emiPayments)))
                : Math.max(...yoyData.map(d => Math.max(d.annualGrowth, d.annualWithdrawals)));
            const scale = 200 / maxValue;

            return (
                <div>
                    <div className="row mb-3">
                        <div className="col-12">
                            <div className="btn-group mb-3" role="group">
                                <button 
                                    type="button" 
                                    className={`btn ${chartType === 'outflow' ? 'btn-primary' : 'btn-outline-primary'}`}
                                    onClick={() => setChartType('outflow')}
                                >
                                    <i className="fas fa-chart-line me-2"></i>Outflow Analysis
                                </button>
                                <button 
                                    type="button" 
                                    className={`btn ${chartType === 'yoy' ? 'btn-primary' : 'btn-outline-primary'}`}
                                    onClick={() => setChartType('yoy')}
                                >
                                    <i className="fas fa-chart-bar me-2"></i>YoY Growth vs Withdrawal
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {chartType === 'outflow' ? (
                    <div className="row mb-3">
                        <div className="col-md-3">
                            <div className="d-flex align-items-center">
                                <div style={{width: '20px', height: '3px', backgroundColor: '#28a745', marginRight: '8px'}}></div>
                                <small>Investment Growth</small>
                            </div>
                        </div>
                        <div className="col-md-3">
                            <div className="d-flex align-items-center">
                                <div style={{width: '20px', height: '3px', backgroundColor: '#dc3545', marginRight: '8px'}}></div>
                                <small>Expenses Withdrawn</small>
                            </div>
                        </div>
                        <div className="col-md-3">
                            <div className="d-flex align-items-center">
                                <div style={{width: '20px', height: '3px', backgroundColor: '#ffc107', marginRight: '8px'}}></div>
                                <small>EMI Payments</small>
                            </div>
                        </div>
                        <div className="col-md-3">
                            <div className="d-flex align-items-center">
                                <div style={{width: '20px', height: '3px', backgroundColor: '#6f42c1', marginRight: '8px'}}></div>
                                <small>Total Outflow</small>
                            </div>
                        </div>
                    </div>
                    ) : (
                    <div className="row mb-3">
                        <div className="col-md-4">
                            <div className="d-flex align-items-center">
                                <div style={{width: '20px', height: '15px', backgroundColor: '#28a745', marginRight: '8px'}}></div>
                                <small>Annual Growth</small>
                            </div>
                        </div>
                        <div className="col-md-4">
                            <div className="d-flex align-items-center">
                                <div style={{width: '20px', height: '15px', backgroundColor: '#dc3545', marginRight: '8px'}}></div>
                                <small>Annual Withdrawals</small>
                            </div>
                        </div>
                        <div className="col-md-4">
                            <div className="d-flex align-items-center">
                                <div style={{width: '20px', height: '3px', backgroundColor: '#007bff', marginRight: '8px'}}></div>
                                <small>Net Change (Growth - Withdrawals)</small>
                            </div>
                        </div>
                    </div>
                    )}
                    
                    <div style={{height: '400px', position: 'relative', border: '1px solid #dee2e6', borderRadius: '8px', padding: '20px', backgroundColor: '#f8f9fa'}}>
                        <canvas
                            ref={(canvas) => {
                                if (canvas) {
                                    const ctx = canvas.getContext('2d');
                                    canvas.width = 800;
                                    canvas.height = 300;
                                    
                                    // Clear canvas
                                    ctx.clearRect(0, 0, 800, 300);
                                    
                                    // Draw grid
                                    ctx.strokeStyle = '#e9ecef';
                                    ctx.lineWidth = 1;
                                    for (let i = 0; i <= 5; i++) {
                                        ctx.beginPath();
                                        ctx.moveTo(50, 50 + i * 40);
                                        ctx.lineTo(750, 50 + i * 40);
                                        ctx.stroke();
                                    }
                                    
                                    // Draw Y-axis labels
                                    ctx.fillStyle = '#6c757d';
                                    ctx.font = '10px Arial';
                                    ctx.textAlign = 'right';
                                    for (let i = 0; i <= 5; i++) {
                                        const value = (maxValue * (5-i) / 5) / 10000000;
                                        ctx.fillText(`₹${value.toFixed(1)}Cr`, 40, 55 + i * 40);
                                    }
                                    
                                    if (chartType === 'corpus') {
                                        // Draw corpus lines
                                        const drawLine = (data, color, width = 2, dash = false) => {
                                            ctx.strokeStyle = color;
                                            ctx.lineWidth = width;
                                            if (dash) ctx.setLineDash([5, 5]);
                                            else ctx.setLineDash([]);
                                            
                                            ctx.beginPath();
                                            data.forEach((d, i) => {
                                                const x = 50 + (i * 23.3);
                                                const y = 250 - (d * scale);
                                                if (i === 0) ctx.moveTo(x, y);
                                                else ctx.lineTo(x, y);
                                            });
                                            ctx.stroke();
                                        };
                                        
                                        // Draw corpus lines
                                        drawLine(corpusData.map(d => d.corpusStartOfYear), '#28a745', 3); // Total corpus
                                        drawLine(corpusData.map(d => d.corpusAfterWithdrawals), '#007bff', 2); // After withdrawals
                                        drawLine(corpusData.map(d => d.yearlyWithdrawals), '#dc3545', 2, true); // Withdrawals
                                        drawLine(corpusData.map(d => d.annualGrowthFromCorpus), '#ffc107', 2, true); // Growth
                                        
                                    } else {
                                        // Draw outflow lines
                                        const drawLine = (data, color, width = 2, dash = false) => {
                                            ctx.strokeStyle = color;
                                            ctx.lineWidth = width;
                                            if (dash) ctx.setLineDash([5, 5]);
                                            else ctx.setLineDash([]);
                                            
                                            ctx.beginPath();
                                            data.forEach((d, i) => {
                                                const x = 50 + (i * 23.3);
                                                const y = 250 - (d * scale);
                                                if (i === 0) ctx.moveTo(x, y);
                                                else ctx.lineTo(x, y);
                                            });
                                            ctx.stroke();
                                        };
                                        
                                        // Draw outflow lines
                                        drawLine(outflowData.map(d => d.expensesWithdrawn), '#dc3545', 2);
                                        drawLine(outflowData.map(d => d.emiPayments), '#ffc107', 2);
                                        drawLine(outflowData.map(d => d.totalOutflow), '#6f42c1', 3, true);
                                    }
                                    
                                    // Draw SWP start marker (for both charts)
                                    if (swpPlan.yearsToSwpStart <= 30) {
                                        ctx.strokeStyle = '#e83e8c';
                                        ctx.lineWidth = 2;
                                        ctx.setLineDash([3, 3]);
                                        ctx.beginPath();
                                        const x = 50 + (swpPlan.yearsToSwpStart * 23.3);
                                        ctx.moveTo(x, 50);
                                        ctx.lineTo(x, 250);
                                        ctx.stroke();
                                        
                                        ctx.fillStyle = '#e83e8c';
                                        ctx.textAlign = 'center';
                                        ctx.fillText('SWP Start', x, 45);
                                    }
                                    
                                    // Draw X-axis labels
                                    ctx.fillStyle = '#6c757d';
                                    ctx.textAlign = 'center';
                                    const dataToUse = chartType === 'corpus' ? corpusData : outflowData;
                                    dataToUse.filter((_, i) => i % 5 === 0).forEach((d, i) => {
                                        ctx.fillText(`Year ${d.year}`, 50 + (i * 5 * 23.3), 270);
                                    });
                                }
                            }}
                            width={800}
                            height={300}
                            style={{ width: '100%', height: '100%' }}
                        />
                    </div>
                    <div className="mt-3">
                        <h6>Key Insights:</h6>
                        {chartType === 'corpus' ? (
                            <ul className="list-unstyled">
                                <li>• Peak Corpus Value: ₹{(Math.max(...corpusData.map(d => d.corpusStartOfYear)) / 10000000).toFixed(1)}Cr</li>
                                <li>• Corpus at SWP Start: ₹{(corpusData[swpPlan.yearsToSwpStart]?.corpusStartOfYear / 10000000 || 0).toFixed(1)}Cr (Year {swpPlan.yearsToSwpStart})</li>
                                <li>• Corpus Depletion: Year {(() => {
                                    const depletionYear = corpusData.find(d => d.year >= swpPlan.yearsToSwpStart && d.corpusAfterWithdrawals <= 0);
                                    if (depletionYear) {
                                        return depletionYear.year;
                                    }
                                    const sustainabilityEndYear = swpPlan.yearsToSwpStart + Math.floor(swpPlan.sustainabilityYears);
                                    return sustainabilityEndYear <= 30 ? sustainabilityEndYear : `Beyond 30 years`;
                                })()}</li>
                                <li>• Sustainability Period: {swpPlan.sustainabilityYears.toFixed(1)} years from SWP start</li>
                            </ul>
                        ) : (
                            <ul className="list-unstyled">
                                <li>• Peak Annual Expenses: ₹{(Math.max(...outflowData.map(d => d.expensesWithdrawn)) / 100000).toFixed(1)}L (inflation-adjusted)</li>
                                <li>• SWP Starts: Year {swpPlan.yearsToSwpStart} ({swpPlan.swpStartYear})</li>
                                <li>• EMI Completion: Year {Math.max(...(data.liabilities.length > 0 ? data.liabilities.map(l => parseFloat(l.years)) : [0]))}</li>
                                <li>• Peak Total Outflow: ₹{(Math.max(...outflowData.map(d => d.totalOutflow)) / 100000).toFixed(1)}L (expenses + EMI)</li>
                            </ul>
                        )}
                    </div>
                </div>
            );
        }

        function WealthPlanApp() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [data, setData] = useState({
                cash: 0,
                investments: [],
                expenses: [],
                incomes: [],
                liabilities: [],
                swpPlan: null,
                inflationRate: 6, // Default inflation rate
                postRetirementReturn: 8 // Default post-retirement return
            });

            // Load data from localStorage on component mount
            useEffect(() => {
                const savedData = localStorage.getItem('wealthPlanProData');
                if (savedData) {
                    setData(JSON.parse(savedData));
                }
            }, []);

            // Save data to localStorage whenever data changes
            useEffect(() => {
                localStorage.setItem('wealthPlanProData', JSON.stringify(data));
            }, [data]);

            const addInvestment = (investment) => {
                setData(prev => ({
                    ...prev,
                    investments: [...prev.investments, { ...investment, id: Date.now() }]
                }));
            };

            const addExpense = (expense) => {
                setData(prev => ({
                    ...prev,
                    expenses: [...prev.expenses, { ...expense, id: Date.now() }]
                }));
            };

            const addIncome = (income) => {
                setData(prev => ({
                    ...prev,
                    incomes: [...prev.incomes, { ...income, id: Date.now() }]
                }));
            };

            const addLiability = (liability) => {
                setData(prev => ({
                    ...prev,
                    liabilities: [...prev.liabilities, { ...liability, id: Date.now() }]
                }));
            };

            const deleteItem = (type, id) => {
                setData(prev => ({
                    ...prev,
                    [type]: prev[type].filter(item => item.id !== id)
                }));
            };

            const generateSWPPlan = (startYear) => {
                if (!startYear) {
                    alert('Please enter the SWP start year');
                    return;
                }

                const currentYear = new Date().getFullYear();
                const yearsToSwpStart = parseInt(startYear) - currentYear;
                
                if (yearsToSwpStart < 0) {
                    alert('SWP start year cannot be in the past');
                    return;
                }

                // Calculate total investment value at SWP start year
                let totalInvestmentValue = data.cash;
                
                data.investments.forEach(inv => {
                    const investmentYears = parseFloat(inv.years);
                    if (yearsToSwpStart <= investmentYears) {
                        // Investment is still ongoing at SWP start
                        if (inv.type === 'SIP') {
                            totalInvestmentValue += calculateSIP(parseFloat(inv.monthlyAmount), parseFloat(inv.expectedReturn), yearsToSwpStart);
                        } else {
                            totalInvestmentValue += calculateLumpsum(parseFloat(inv.amount), parseFloat(inv.expectedReturn), yearsToSwpStart);
                        }
                    } else {
                        // Investment has matured, calculate final value and growth
                        let finalValue;
                        if (inv.type === 'SIP') {
                            finalValue = calculateSIP(parseFloat(inv.monthlyAmount), parseFloat(inv.expectedReturn), investmentYears);
                        } else {
                            finalValue = calculateLumpsum(parseFloat(inv.amount), parseFloat(inv.expectedReturn), investmentYears);
                        }
                        // Grow the final value at post-retirement rate
                        const additionalYears = yearsToSwpStart - investmentYears;
                        totalInvestmentValue += finalValue * Math.pow(1 + data.postRetirementReturn / 100, additionalYears);
                    }
                });

                // Calculate current total monthly expenses (only regular expenses, not EMIs)
                let currentMonthlyExpenses = 0;
                data.expenses.forEach(exp => {
                    if (exp.type === 'Monthly') {
                        currentMonthlyExpenses += parseFloat(exp.amount);
                    } else if (exp.type === 'Yearly') {
                        currentMonthlyExpenses += parseFloat(exp.amount) / 12;
                    }
                });

                // Calculate EMI amounts that will be active at SWP start
                // Key insight: EMIs are currently funded by income, but will need SWP funding after retirement
                let monthlyEMIAtSwpStart = 0;
                let activeLiabilitiesAtSwpStart = [];
                
                data.liabilities.forEach(liability => {
                    const loanTenure = parseFloat(liability.years);
                    const loanStartYear = new Date().getFullYear(); // Assuming loans started this year
                    const loanEndYear = loanStartYear + loanTenure;
                    
                    if (parseInt(startYear) < loanEndYear) {
                        // Loan will still be active when SWP starts - needs to be funded from SWP
                        const emi = calculateEMI(parseFloat(liability.principal), parseFloat(liability.interestRate), loanTenure);
                        monthlyEMIAtSwpStart += emi;
                        activeLiabilitiesAtSwpStart.push({
                            ...liability,
                            emi: emi,
                            remainingYears: loanEndYear - parseInt(startYear)
                        });
                    }
                });

                // Total monthly outflow at SWP start (expenses + EMIs that need SWP funding)
                const totalMonthlyOutflowAtSwpStart = currentMonthlyExpenses + monthlyEMIAtSwpStart;

                // Calculate inflation-adjusted expenses at SWP start
                const inflationAdjustedMonthlyExpenses = calculateInflationAdjustedExpense(
                    currentMonthlyExpenses, 
                    data.inflationRate, 
                    yearsToSwpStart
                );

                // EMIs don't inflate - they remain fixed amounts that need to be withdrawn from SWP
                const totalInflationAdjustedOutflow = inflationAdjustedMonthlyExpenses + monthlyEMIAtSwpStart;

                // Calculate SWP sustainability with inflation using total outflow
                const sustainabilityMonths = calculateSWPWithInflation(
                    totalInvestmentValue, 
                    totalInflationAdjustedOutflow, 
                    data.postRetirementReturn,
                    data.inflationRate
                );
                
                const swpPlan = {
                    totalInvestmentValue,
                    currentMonthlyExpenses,
                    monthlyEMIAtSwpStart,
                    totalMonthlyOutflowAtSwpStart,
                    inflationAdjustedMonthlyExpenses,
                    totalInflationAdjustedOutflow,
                    sustainabilityYears: sustainabilityMonths / 12,
                    sustainabilityMonths,
                    swpStartYear: parseInt(startYear),
                    yearsToSwpStart,
                    inflationRate: data.inflationRate,
                    postRetirementReturn: data.postRetirementReturn,
                    investmentPeriod: yearsToSwpStart,
                    activeLiabilitiesAtSwpStart: activeLiabilitiesAtSwpStart
                };

                setData(prev => ({ ...prev, swpPlan, swpStartYear: parseInt(startYear) }));
            };

            const netWorth = calculateNetWorth(data);

            return (
                <div className="container-fluid p-4">
                    <div className="main-container">
                        <div className="p-4">
                            <h1 className="text-center mb-4">
                                <i className="fas fa-chart-line me-3"></i>
                                WealthPlan Pro - Advanced Financial Planner
                            </h1>
                            
                            <ul className="nav nav-tabs mb-4">
                                <li className="nav-item">
                                    <button 
                                        className={`nav-link ${activeTab === 'dashboard' ? 'active' : ''}`}
                                        onClick={() => setActiveTab('dashboard')}
                                    >
                                        <i className="fas fa-tachometer-alt me-2"></i>Dashboard
                                    </button>
                                </li>
                                <li className="nav-item">
                                    <button 
                                        className={`nav-link ${activeTab === 'investments' ? 'active' : ''}`}
                                        onClick={() => setActiveTab('investments')}
                                    >
                                        <i className="fas fa-piggy-bank me-2"></i>Investments
                                    </button>
                                </li>
                                <li className="nav-item">
                                    <button 
                                        className={`nav-link ${activeTab === 'income' ? 'active' : ''}`}
                                        onClick={() => setActiveTab('income')}
                                    >
                                        <i className="fas fa-rupee-sign me-2"></i>Income
                                    </button>
                                </li>
                                <li className="nav-item">
                                    <button 
                                        className={`nav-link ${activeTab === 'expenses' ? 'active' : ''}`}
                                        onClick={() => setActiveTab('expenses')}
                                    >
                                        <i className="fas fa-receipt me-2"></i>Expenses
                                    </button>
                                </li>
                                <li className="nav-item">
                                    <button 
                                        className={`nav-link ${activeTab === 'liabilities' ? 'active' : ''}`}
                                        onClick={() => setActiveTab('liabilities')}
                                    >
                                        <i className="fas fa-home me-2"></i>Liabilities
                                    </button>
                                </li>
                                <li className="nav-item">
                                    <button 
                                        className={`nav-link ${activeTab === 'swp' ? 'active' : ''}`}
                                        onClick={() => setActiveTab('swp')}
                                    >
                                        <i className="fas fa-chart-pie me-2"></i>SWP Plan
                                    </button>
                                </li>
                            </ul>

                            <div className="tab-content">
                                {activeTab === 'dashboard' && <DashboardTab data={data} netWorth={netWorth} />}
                                {activeTab === 'investments' && <InvestmentsTab data={data} setData={setData} addInvestment={addInvestment} deleteItem={deleteItem} />}
                                {activeTab === 'income' && <IncomeTab data={data} setData={setData} addIncome={addIncome} deleteItem={deleteItem} />}
                                {activeTab === 'expenses' && <ExpensesTab data={data} setData={setData} addExpense={addExpense} deleteItem={deleteItem} />}
                                {activeTab === 'liabilities' && <LiabilitiesTab data={data} setData={setData} addLiability={addLiability} deleteItem={deleteItem} />}
                                {activeTab === 'swp' && <SWPTab data={data} setData={setData} generateSWPPlan={generateSWPPlan} />}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function DashboardTab({ data, netWorth }) {
            const totalInvestments = data.investments.reduce((total, inv) => {
                if (inv.type === 'SIP') {
                    return total + calculateSIP(parseFloat(inv.monthlyAmount), parseFloat(inv.expectedReturn), parseFloat(inv.years));
                } else {
                    return total + calculateLumpsum(parseFloat(inv.amount), parseFloat(inv.expectedReturn), parseFloat(inv.years));
                }
            }, 0);

            const totalLiabilities = data.liabilities.reduce((total, liability) => {
                return total + parseFloat(liability.principal);
            }, 0);

            const monthlyExpenses = data.expenses.reduce((total, expense) => {
                if (expense.type === 'Monthly') return total + parseFloat(expense.amount);
                if (expense.type === 'Yearly') return total + parseFloat(expense.amount) / 12;
                return total;
            }, 0);

            const monthlyEMI = data.liabilities.reduce((total, liability) => {
                return total + calculateEMI(parseFloat(liability.principal), parseFloat(liability.interestRate), parseFloat(liability.years));
            }, 0);

            return (
                <div>
                    <div className="net-worth-display">
                        <h2><i className="fas fa-wallet me-3"></i>Current Net Worth</h2>
                        <h1 className="display-4">₹{netWorth.toLocaleString()}</h1>
                        <p className="mb-0">Assets - Liabilities = Net Worth</p>
                    </div>

                    <div className="summary-grid">
                        <div className="summary-card">
                            <h6><i className="fas fa-coins me-2"></i>Cash Holdings</h6>
                            <h4>₹{data.cash.toLocaleString()}</h4>
                        </div>
                        
                        <div className="summary-card info-card">
                            <h6><i className="fas fa-chart-line me-2"></i>Future Investment Value</h6>
                            <h4>₹{totalInvestments.toLocaleString()}</h4>
                        </div>
                        
                        <div className="summary-card warning-card">
                            <h6><i className="fas fa-credit-card me-2"></i>Total Liabilities</h6>
                            <h4>₹{totalLiabilities.toLocaleString()}</h4>
                        </div>
                        
                        <div className="summary-card">
                            <h6><i className="fas fa-shopping-cart me-2"></i>Monthly Expenses</h6>
                            <h4>₹{monthlyExpenses.toLocaleString()}</h4>
                        </div>
                        
                        <div className="summary-card danger-card">
                            <h6><i className="fas fa-money-bill me-2"></i>Monthly EMI</h6>
                            <h4>₹{monthlyEMI.toLocaleString()}</h4>
                        </div>
                        
                        <div className="summary-card info-card">
                            <h6><i className="fas fa-calculator me-2"></i>Total Monthly Outflow</h6>
                            <h4>₹{(monthlyExpenses + monthlyEMI).toLocaleString()}</h4>
                        </div>
                    </div>

                    <div className="row mt-4">
                        <div className="col-md-6">
                            <div className="card">
                                <div className="card-header">
                                    <h5><i className="fas fa-chart-bar me-2"></i>Investment Portfolio</h5>
                                </div>
                                <div className="card-body">
                                    {data.investments.length > 0 ? (
                                        data.investments.map(inv => (
                                            <div key={inv.id} className="d-flex justify-content-between align-items-center mb-2">
                                                <span>{inv.type} - {inv.expectedReturn}%</span>
                                                <span className="badge bg-success">
                                                    ₹{(inv.type === 'SIP' ? 
                                                        calculateSIP(parseFloat(inv.monthlyAmount), parseFloat(inv.expectedReturn), parseFloat(inv.years)) :
                                                        calculateLumpsum(parseFloat(inv.amount), parseFloat(inv.expectedReturn), parseFloat(inv.years))
                                                    ).toLocaleString()}
                                                </span>
                                            </div>
                                        ))
                                    ) : (
                                        <p className="text-muted">No investments added yet</p>
                                    )}
                                </div>
                            </div>
                        </div>
                        
                        <div className="col-md-6">
                            <div className="card">
                                <div className="card-header">
                                    <h5><i className="fas fa-exclamation-triangle me-2"></i>Financial Health Score</h5>
                                </div>
                                <div className="card-body">
                                    {(() => {
                                        const score = Math.min(100, Math.max(0, (netWorth / 1000000) * 50 + (totalInvestments / 5000000) * 30 + 20));
                                        const scoreColor = score >= 70 ? 'success' : score >= 40 ? 'warning' : 'danger';
                                        return (
                                            <>
                                                <div className="d-flex justify-content-between mb-2">
                                                    <span>Overall Score</span>
                                                    <span className={`text-${scoreColor}`}>{score.toFixed(0)}/100</span>
                                                </div>
                                                <div className="progress progress-custom mb-3">
                                                    <div 
                                                        className={`progress-bar bg-${scoreColor}`}
                                                        style={{width: `${score}%`}}
                                                    ></div>
                                                </div>
                                                <small className="text-muted">
                                                    Based on net worth, investment portfolio, and financial planning
                                                </small>
                                            </>
                                        );
                                    })()}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function InvestmentsTab({ data, setData, addInvestment, deleteItem }) {
            const [investmentForm, setInvestmentForm] = useState({
                type: 'SIP',
                monthlyAmount: '',
                amount: '',
                expectedReturn: '',
                years: '',
                yearsInvested: ''
            });
            const [editingId, setEditingId] = useState(null);
            const [cashAmount, setCashAmount] = useState(data.cash);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (editingId) {
                    // Update existing investment
                    setData(prev => ({
                        ...prev,
                        investments: prev.investments.map(inv => 
                            inv.id === editingId ? { ...investmentForm, id: editingId } : inv
                        )
                    }));
                    setEditingId(null);
                } else {
                    // Add new investment
                    addInvestment(investmentForm);
                }
                setInvestmentForm({
                    type: 'SIP',
                    monthlyAmount: '',
                    amount: '',
                    expectedReturn: '',
                    years: '',
                    yearsInvested: ''
                });
            };

            const startEdit = (investment) => {
                setInvestmentForm(investment);
                setEditingId(investment.id);
            };

            const cancelEdit = () => {
                setInvestmentForm({
                    type: 'SIP',
                    monthlyAmount: '',
                    amount: '',
                    expectedReturn: '',
                    years: '',
                    yearsInvested: ''
                });
                setEditingId(null);
            };

            const updateCash = () => {
                setData(prev => ({ ...prev, cash: parseFloat(cashAmount) || 0 }));
            };

            return (
                <div className="row">
                    <div className="col-md-6">
                        <div className="card">
                            <div className="card-header">
                                <h5><i className="fas fa-wallet me-2"></i>Cash Holdings</h5>
                            </div>
                            <div className="card-body">
                                <div className="input-group">
                                    <span className="input-group-text">₹</span>
                                    <input
                                        type="number"
                                        className="form-control"
                                        value={cashAmount}
                                        onChange={(e) => setCashAmount(e.target.value)}
                                        placeholder="Enter cash amount"
                                    />
                                    <button className="btn btn-primary" onClick={updateCash}>
                                        Update
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="card">
                            <div className="card-header">
                                <h5><i className="fas fa-plus me-2"></i>{editingId ? 'Edit Investment' : 'Add Investment'}</h5>
                            </div>
                            <div className="card-body">
                                <form onSubmit={handleSubmit}>
                                    <div className="mb-3">
                                        <label className="form-label">Investment Type</label>
                                        <select 
                                            className="form-select"
                                            value={investmentForm.type}
                                            onChange={(e) => setInvestmentForm(prev => ({ ...prev, type: e.target.value }))}
                                        >
                                            <option value="SIP">SIP (Systematic Investment Plan)</option>
                                            <option value="Lumpsum">Lumpsum Investment</option>
                                        </select>
                                    </div>

                                    {investmentForm.type === 'SIP' ? (
                                        <>
                                            <div className="mb-3">
                                                <label className="form-label">Monthly Amount (₹)</label>
                                                <input
                                                    type="number"
                                                    className="form-control"
                                                    value={investmentForm.monthlyAmount}
                                                    onChange={(e) => setInvestmentForm(prev => ({ ...prev, monthlyAmount: e.target.value }))}
                                                    required
                                                />
                                            </div>
                                            <div className="mb-3">
                                                <label className="form-label">Years Already Invested (Optional)</label>
                                                <input
                                                    type="number"
                                                    className="form-control"
                                                    value={investmentForm.yearsInvested}
                                                    onChange={(e) => setInvestmentForm(prev => ({ ...prev, yearsInvested: e.target.value }))}
                                                    placeholder="0"
                                                />
                                            </div>
                                        </>
                                    ) : (
                                        <div className="mb-3">
                                            <label className="form-label">Investment Amount (₹)</label>
                                            <input
                                                type="number"
                                                className="form-control"
                                                value={investmentForm.amount}
                                                onChange={(e) => setInvestmentForm(prev => ({ ...prev, amount: e.target.value }))}
                                                required
                                            />
                                        </div>
                                    )}

                                    <div className="mb-3">
                                        <label className="form-label">Expected Annual Return (%)</label>
                                        <input
                                            type="number"
                                            step="0.1"
                                            className="form-control"
                                            value={investmentForm.expectedReturn}
                                            onChange={(e) => setInvestmentForm(prev => ({ ...prev, expectedReturn: e.target.value }))}
                                            required
                                        />
                                    </div>

                                    <div className="mb-3">
                                        <label className="form-label">Total Investment Period (Years)</label>
                                        <input
                                            type="number"
                                            className="form-control"
                                            value={investmentForm.years}
                                            onChange={(e) => setInvestmentForm(prev => ({ ...prev, years: e.target.value }))}
                                            required
                                        />
                                    </div>

                                    <div className="d-flex gap-2">
                                        <button type="submit" className="btn btn-primary flex-fill">
                                            <i className={`fas ${editingId ? 'fa-save' : 'fa-plus'} me-2`}></i>
                                            {editingId ? 'Update Investment' : 'Add Investment'}
                                        </button>
                                        {editingId && (
                                            <button type="button" className="btn btn-secondary" onClick={cancelEdit}>
                                                <i className="fas fa-times me-2"></i>Cancel
                                            </button>
                                        )}
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div className="col-md-6">
                        <div className="card">
                            <div className="card-header">
                                <h5><i className="fas fa-list me-2"></i>Your Investments</h5>
                            </div>
                            <div className="card-body">
                                <div className="mb-3">
                                    <strong>Cash: ₹{data.cash.toLocaleString()}</strong>
                                </div>
                                
                                {data.investments.map(investment => (
                                    <div key={investment.id} className="investment-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{investment.type}</strong><br />
                                            {investment.type === 'SIP' ? 
                                                `₹${investment.monthlyAmount}/month` : 
                                                `₹${investment.amount}`
                                            }<br />
                                            <small className="text-muted">
                                                {investment.expectedReturn}% for {investment.years} years
                                                {investment.yearsInvested && ` (${investment.yearsInvested} years invested)`}
                                            </small><br />
                                            <small className="text-success">
                                                Future Value: ₹{(investment.type === 'SIP' ? 
                                                    calculateSIP(parseFloat(investment.monthlyAmount), parseFloat(investment.expectedReturn), parseFloat(investment.years)) :
                                                    calculateLumpsum(parseFloat(investment.amount), parseFloat(investment.expectedReturn), parseFloat(investment.years))
                                                ).toLocaleString()}
                                            </small>
                                        </div>
                                        <div className="d-flex gap-2">
                                            <button 
                                                className="btn btn-sm btn-outline-primary"
                                                onClick={() => startEdit(investment)}
                                            >
                                                <i className="fas fa-edit"></i>
                                            </button>
                                            <button 
                                                className="delete-btn"
                                                onClick={() => deleteItem('investments', investment.id)}
                                            >
                                                <i className="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                ))}
                                
                                {data.investments.length === 0 && (
                                    <p className="text-muted text-center">No investments added yet</p>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function ExpensesTab({ data, setData, addExpense, deleteItem }) {
            const [expenseForm, setExpenseForm] = useState({
                name: '',
                amount: '',
                type: 'Monthly'
            });
            const [editingId, setEditingId] = useState(null);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (editingId) {
                    // Update existing expense
                    setData(prev => ({
                        ...prev,
                        expenses: prev.expenses.map(exp => 
                            exp.id === editingId ? { ...expenseForm, id: editingId } : exp
                        )
                    }));
                    setEditingId(null);
                } else {
                    // Add new expense
                    addExpense(expenseForm);
                }
                setExpenseForm({ name: '', amount: '', type: 'Monthly' });
            };

            const startEdit = (expense) => {
                setExpenseForm(expense);
                setEditingId(expense.id);
            };

            const cancelEdit = () => {
                setExpenseForm({ name: '', amount: '', type: 'Monthly' });
                setEditingId(null);
            };

            const totalMonthlyExpenses = data.expenses.reduce((total, expense) => {
                if (expense.type === 'Monthly') return total + parseFloat(expense.amount);
                if (expense.type === 'Yearly') return total + parseFloat(expense.amount) / 12;
                return total;
            }, 0);

            const totalYearlyExpenses = data.expenses.reduce((total, expense) => {
                if (expense.type === 'Monthly') return total + parseFloat(expense.amount) * 12;
                if (expense.type === 'Yearly') return total + parseFloat(expense.amount);
                return total;
            }, 0);

            return (
                <div className="row">
                    <div className="col-md-6">
                        <div className="card">
                            <div className="card-header">
                                <h5><i className="fas fa-plus me-2"></i>{editingId ? 'Edit Expense' : 'Add Expense'}</h5>
                            </div>
                            <div className="card-body">
                                <form onSubmit={handleSubmit}>
                                    <div className="mb-3">
                                        <label className="form-label">Expense Name</label>
                                        <input
                                            type="text"
                                            className="form-control"
                                            value={expenseForm.name}
                                            onChange={(e) => setExpenseForm(prev => ({ ...prev, name: e.target.value }))}
                                            placeholder="e.g., Groceries, Rent, Insurance"
                                            required
                                        />
                                    </div>

                                    <div className="mb-3">
                                        <label className="form-label">Amount (₹)</label>
                                        <input
                                            type="number"
                                            className="form-control"
                                            value={expenseForm.amount}
                                            onChange={(e) => setExpenseForm(prev => ({ ...prev, amount: e.target.value }))}
                                            required
                                        />
                                    </div>

                                    <div className="mb-3">
                                        <label className="form-label">Expense Type</label>
                                        <select 
                                            className="form-select"
                                            value={expenseForm.type}
                                            onChange={(e) => setExpenseForm(prev => ({ ...prev, type: e.target.value }))}
                                        >
                                            <option value="Monthly">Monthly</option>
                                            <option value="Yearly">Yearly</option>
                                            <option value="One-time">One-time</option>
                                        </select>
                                    </div>

                                    <div className="d-flex gap-2">
                                        <button type="submit" className="btn btn-primary flex-fill">
                                            <i className={`fas ${editingId ? 'fa-save' : 'fa-plus'} me-2`}></i>
                                            {editingId ? 'Update Expense' : 'Add Expense'}
                                        </button>
                                        {editingId && (
                                            <button type="button" className="btn btn-secondary" onClick={cancelEdit}>
                                                <i className="fas fa-times me-2"></i>Cancel
                                            </button>
                                        )}
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div className="col-md-6">
                        <div className="card">
                            <div className="card-header">
                                <h5><i className="fas fa-list me-2"></i>Your Expenses</h5>
                            </div>
                            <div className="card-body">
                                <div className="row mb-3">
                                    <div className="col-6">
                                        <div className="result-card">
                                            <h6>Monthly Total</h6>
                                            <h5>₹{totalMonthlyExpenses.toLocaleString()}</h5>
                                        </div>
                                    </div>
                                    <div className="col-6">
                                        <div className="result-card">
                                            <h6>Yearly Total</h6>
                                            <h5>₹{totalYearlyExpenses.toLocaleString()}</h5>
                                        </div>
                                    </div>
                                </div>
                                
                                {data.expenses.map(expense => (
                                    <div key={expense.id} className="expense-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{expense.name}</strong><br />
                                            <span className="text-success">₹{parseFloat(expense.amount).toLocaleString()}</span>
                                            <span className="badge bg-secondary ms-2">{expense.type}</span>
                                        </div>
                                        <div className="d-flex gap-2">
                                            <button 
                                                className="btn btn-sm btn-outline-primary"
                                                onClick={() => startEdit(expense)}
                                            >
                                                <i className="fas fa-edit"></i>
                                            </button>
                                            <button 
                                                className="delete-btn"
                                                onClick={() => deleteItem('expenses', expense.id)}
                                            >
                                                <i className="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                ))}
                                
                                {data.expenses.length === 0 && (
                                    <p className="text-muted text-center">No expenses added yet</p>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function LiabilitiesTab({ data, setData, addLiability, deleteItem }) {
            const [liabilityForm, setLiabilityForm] = useState({
                name: '',
                principal: '',
                interestRate: '',
                years: ''
            });
            const [editingId, setEditingId] = useState(null);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (editingId) {
                    // Update existing liability
                    setData(prev => ({
                        ...prev,
                        liabilities: prev.liabilities.map(liability => 
                            liability.id === editingId ? { ...liabilityForm, id: editingId } : liability
                        )
                    }));
                    setEditingId(null);
                } else {
                    // Add new liability
                    addLiability(liabilityForm);
                }
                setLiabilityForm({ name: '', principal: '', interestRate: '', years: '' });
            };

            const startEdit = (liability) => {
                setLiabilityForm(liability);
                setEditingId(liability.id);
            };

            const cancelEdit = () => {
                setLiabilityForm({ name: '', principal: '', interestRate: '', years: '' });
                setEditingId(null);
            };

            const totalEMI = data.liabilities.reduce((total, liability) => {
                return total + calculateEMI(parseFloat(liability.principal), parseFloat(liability.interestRate), parseFloat(liability.years));
            }, 0);

            return (
                <div className="row">
                    <div className="col-md-6">
                        <div className="card">
                            <div className="card-header">
                                <h5><i className="fas fa-plus me-2"></i>{editingId ? 'Edit Liability' : 'Add Liability'}</h5>
                            </div>
                            <div className="card-body">
                                <form onSubmit={handleSubmit}>
                                    <div className="mb-3">
                                        <label className="form-label">Liability Name</label>
                                        <input
                                            type="text"
                                            className="form-control"
                                            value={liabilityForm.name}
                                            onChange={(e) => setLiabilityForm(prev => ({ ...prev, name: e.target.value }))}
                                            placeholder="e.g., Home Loan, Car Loan, Personal Loan"
                                            required
                                        />
                                    </div>

                                    <div className="mb-3">
                                        <label className="form-label">Principal Amount (₹)</label>
                                        <input
                                            type="number"
                                            className="form-control"
                                            value={liabilityForm.principal}
                                            onChange={(e) => setLiabilityForm(prev => ({ ...prev, principal: e.target.value }))}
                                            required
                                        />
                                    </div>

                                    <div className="mb-3">
                                        <label className="form-label">Interest Rate (% per annum)</label>
                                        <input
                                            type="number"
                                            step="0.1"
                                            className="form-control"
                                            value={liabilityForm.interestRate}
                                            onChange={(e) => setLiabilityForm(prev => ({ ...prev, interestRate: e.target.value }))}
                                            required
                                        />
                                    </div>

                                    <div className="mb-3">
                                        <label className="form-label">Loan Tenure (Years)</label>
                                        <input
                                            type="number"
                                            className="form-control"
                                            value={liabilityForm.years}
                                            onChange={(e) => setLiabilityForm(prev => ({ ...prev, years: e.target.value }))}
                                            required
                                        />
                                    </div>

                                    <div className="d-flex gap-2">
                                        <button type="submit" className="btn btn-primary flex-fill">
                                            <i className={`fas ${editingId ? 'fa-save' : 'fa-plus'} me-2`}></i>
                                            {editingId ? 'Update Liability' : 'Add Liability'}
                                        </button>
                                        {editingId && (
                                            <button type="button" className="btn btn-secondary" onClick={cancelEdit}>
                                                <i className="fas fa-times me-2"></i>Cancel
                                            </button>
                                        )}
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div className="col-md-6">
                        <div className="card">
                            <div className="card-header">
                                <h5><i className="fas fa-list me-2"></i>Your Liabilities</h5>
                            </div>
                            <div className="card-body">
                                <div className="result-card mb-3">
                                    <h6>Total Monthly EMI</h6>
                                    <h4>₹{totalEMI.toLocaleString()}</h4>
                                </div>
                                
                                {data.liabilities.map(liability => {
                                    const emi = calculateEMI(parseFloat(liability.principal), parseFloat(liability.interestRate), parseFloat(liability.years));
                                    const totalPayment = emi * parseFloat(liability.years) * 12;
                                    const totalInterest = totalPayment - parseFloat(liability.principal);
                                    
                                    return (
                                        <div key={liability.id} className="expense-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>{liability.name}</strong><br />
                                                <span className="text-info">Principal: ₹{parseFloat(liability.principal).toLocaleString()}</span><br />
                                                <span className="text-warning">{liability.interestRate}% for {liability.years} years</span><br />
                                                <span className="text-danger">EMI: ₹{emi.toLocaleString()}</span><br />
                                                <small className="text-muted">Total Interest: ₹{totalInterest.toLocaleString()}</small>
                                            </div>
                                            <div className="d-flex gap-2">
                                                <button 
                                                    className="btn btn-sm btn-outline-primary"
                                                    onClick={() => startEdit(liability)}
                                                >
                                                    <i className="fas fa-edit"></i>
                                                </button>
                                                <button 
                                                    className="delete-btn"
                                                    onClick={() => deleteItem('liabilities', liability.id)}
                                                >
                                                    <i className="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                                
                                {data.liabilities.length === 0 && (
                                    <p className="text-muted text-center">No liabilities added yet</p>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function SWPTab({ data, setData, generateSWPPlan }) {
            const [swpStartYear, setSwpStartYear] = useState(data.swpStartYear || '');
            const [showGraph, setShowGraph] = useState(false);

            // Update swpStartYear when data changes
            useEffect(() => {
                if (data.swpStartYear) {
                    setSwpStartYear(data.swpStartYear);
                }
            }, [data.swpStartYear]);

            const updateInflationRate = (rate) => {
                setData(prev => ({ ...prev, inflationRate: parseFloat(rate) }));
            };

            const updatePostRetirementReturn = (rate) => {
                setData(prev => ({ ...prev, postRetirementReturn: parseFloat(rate) }));
            };

            // Calculate current monthly outflow
            const currentMonthlyExpenses = data.expenses.reduce((total, expense) => {
                if (expense.type === 'Monthly') return total + parseFloat(expense.amount);
                if (expense.type === 'Yearly') return total + parseFloat(expense.amount) / 12;
                return total;
            }, 0);

            const currentMonthlyEMI = data.liabilities.reduce((total, liability) => {
                return total + calculateEMI(parseFloat(liability.principal), parseFloat(liability.interestRate), parseFloat(liability.years));
            }, 0);

            const totalMonthlyOutflow = currentMonthlyExpenses + currentMonthlyEMI;

            return (
                <div className="row">
                    <div className="col-12">
                        <div className="card">
                            <div className="card-header">
                                <h5><i className="fas fa-chart-pie me-2"></i>Enhanced SWP Planning with Income Analysis</h5>
                            </div>
                            <div className="card-body">
                                <div className="row mb-4">
                                    <div className="col-md-4">
                                        <label className="form-label">SWP Start Year</label>
                                        <input
                                            type="number"
                                            className="form-control"
                                            value={swpStartYear}
                                            onChange={(e) => setSwpStartYear(e.target.value)}
                                            placeholder="Enter year to start withdrawals"
                                        />
                                        <small className="text-muted">Year when you want to start systematic withdrawals</small>
                                    </div>
                                    <div className="col-md-4">
                                        <label className="form-label">Expected Inflation Rate (%)</label>
                                        <input
                                            type="number"
                                            step="0.1"
                                            className="form-control"
                                            value={data.inflationRate}
                                            onChange={(e) => updateInflationRate(e.target.value)}
                                        />
                                    </div>
                                    <div className="col-md-4">
                                        <label className="form-label">Post-Retirement Return (%)</label>
                                        <input
                                            type="number"
                                            step="0.1"
                                            className="form-control"
                                            value={data.postRetirementReturn}
                                            onChange={(e) => updatePostRetirementReturn(e.target.value)}
                                        />
                                    </div>
                                </div>

                                {/* SWP Analysis Section */}
                                <div className="row mb-4">
                                    <div className="col-12">
                                        <div className="alert alert-info">
                                            <h6><i className="fas fa-info-circle me-2"></i>Current vs SWP Funding Analysis</h6>
                                            <div className="row mb-3">
                                                <div className="col-md-6">
                                                    <h6 className="text-primary">Currently Funded by Income:</h6>
                                                    <div className="row">
                                                        <div className="col-6">
                                                            <strong>Monthly Expenses:</strong> ₹{currentMonthlyExpenses.toLocaleString()}
                                                        </div>
                                                        <div className="col-6">
                                                            <strong>Monthly EMI:</strong> ₹{currentMonthlyEMI.toLocaleString()}
                                                        </div>
                                                    </div>
                                                    <div className="mt-2">
                                                        <strong>Total Current Outflow:</strong> ₹{totalMonthlyOutflow.toLocaleString()}
                                                    </div>
                                                </div>
                                                <div className="col-md-6">
                                                    <h6 className="text-warning">Will Need SWP Funding:</h6>
                                                    <p className="mb-1">• All monthly expenses (inflation-adjusted)</p>
                                                    <p className="mb-1">• EMIs for loans still active during SWP period</p>
                                                    <p className="mb-0">• EMIs completed before SWP won't need corpus funding</p>
                                                </div>
                                            </div>
                                            <div className="alert alert-warning mb-0">
                                                <p className="mb-0"><i className="fas fa-lightbulb me-2"></i>
                                                <strong>Key Insight:</strong> Currently your income covers all expenses and EMIs. 
                                                After retirement, your SWP corpus will need to fund both living expenses AND any remaining loan EMIs.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Graph Toggle */}
                                <div className="row mb-4">
                                    <div className="col-md-6">
                                        <button 
                                            className="btn btn-outline-primary me-3"
                                            onClick={() => setShowGraph(!showGraph)}
                                        >
                                            <i className="fas fa-chart-line me-2"></i>
                                            {showGraph ? 'Hide' : 'Show'} Financial Graph
                                        </button>
                                    </div>
                                </div>

                                <div className="inflation-info">
                                    <h6><i className="fas fa-info-circle me-2"></i>About Inflation Impact</h6>
                                    <p className="mb-0">
                                        Inflation reduces purchasing power over time. At {data.inflationRate}% inflation, 
                                        ₹100 today will have the purchasing power of ₹{(100 / Math.pow(1 + data.inflationRate/100, 10)).toFixed(0)} 
                                        after 10 years. This calculator adjusts your future expenses for inflation.
                                    </p>
                                </div>

                                {/* Financial Graph */}
                                {showGraph && data.swpPlan && (
                                    <div className="row mb-4">
                                        <div className="col-12">
                                            <div className="card">
                                                <div className="card-header">
                                                    <h6><i className="fas fa-chart-area me-2"></i>30-Year Financial Projection</h6>
                                                </div>
                                                <div className="card-body">
                                                    <FinancialGraph data={data} swpPlan={data.swpPlan} />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                <div className="text-center mb-4">
                                    <button className="btn btn-primary btn-lg" onClick={() => generateSWPPlan(swpStartYear)}>
                                        <i className="fas fa-calculator me-2"></i>Generate SWP Plan
                                    </button>
                                </div>

                                {data.swpPlan && (
                                    <div className="summary-grid">
                                        <div className="summary-card">
                                            <h6><i className="fas fa-piggy-bank me-2"></i>Corpus at SWP Start</h6>
                                            <h4>₹{data.swpPlan.totalInvestmentValue.toLocaleString()}</h4>
                                            <small>Available in {data.swpPlan.swpStartYear} ({data.swpPlan.yearsToSwpStart} years from now)</small>
                                        </div>
                                        
                                        <div className="summary-card info-card">
                                            <h6><i className="fas fa-money-bill-wave me-2"></i>Current Monthly Expenses</h6>
                                            <h4>₹{data.swpPlan.currentMonthlyExpenses.toLocaleString()}</h4>
                                            <small>Today's purchasing power</small>
                                        </div>
                                        
                                        <div className="summary-card warning-card">
                                            <h6><i className="fas fa-chart-line me-2"></i>Total Monthly Outflow at SWP Start</h6>
                                            <h4>₹{data.swpPlan.totalInflationAdjustedOutflow.toLocaleString()}</h4>
                                            <small>Expenses + EMI (with {data.swpPlan.inflationRate}% inflation on expenses)</small>
                                        </div>
                                        
                                        {data.swpPlan.activeLiabilitiesAtSwpStart.length > 0 && (
                                            <div className="summary-card danger-card">
                                                <h6><i className="fas fa-exclamation-triangle me-2"></i>Active Loans During SWP</h6>
                                                <h4>{data.swpPlan.activeLiabilitiesAtSwpStart.length} Loan(s)</h4>
                                                <small>₹{data.swpPlan.monthlyEMIAtSwpStart.toLocaleString()}/month from corpus</small>
                                            </div>
                                        )}
                                        
                                        <div className={`summary-card ${data.swpPlan.sustainabilityYears < 10 ? 'danger-card' : data.swpPlan.sustainabilityYears < 20 ? 'warning-card' : ''}`}>
                                            <h6><i className="fas fa-clock me-2"></i>Sustainability Period</h6>
                                            <h4>{data.swpPlan.sustainabilityYears.toFixed(1)} Years</h4>
                                            <small>From {data.swpPlan.swpStartYear} onwards</small>
                                        </div>
                                    </div>
                                )}

                                {data.swpPlan && (
                                    <div className="mt-4">
                                        <div className="card">
                                            <div className="card-body">
                                                <h6><i className="fas fa-lightbulb me-2"></i>Detailed Analysis</h6>
                                                
                                                <div className="row">
                                                    <div className="col-md-6">
                                                        <h6 className="text-primary">SWP Summary</h6>
                                                        <ul className="list-unstyled">
                                                            <li>• SWP Start Year: {data.swpPlan.swpStartYear}</li>
                                                            <li>• Years to SWP Start: {data.swpPlan.yearsToSwpStart}</li>
                                                            <li>• Corpus Value: ₹{data.swpPlan.totalInvestmentValue.toLocaleString()}</li>
                                                            <li>• Post-SWP Return: {data.swpPlan.postRetirementReturn}%</li>
                                                            <li>• Current Expenses: ₹{data.swpPlan.currentMonthlyExpenses.toLocaleString()}</li>
                                                            <li>• EMI at SWP Start: ₹{data.swpPlan.monthlyEMIAtSwpStart.toLocaleString()}</li>
                                                        </ul>
                                                    </div>
                                                    <div className="col-md-6">
                                                        <h6 className="text-warning">Inflation Impact</h6>
                                                        <ul className="list-unstyled">
                                                            <li>• Inflation Rate: {data.swpPlan.inflationRate}%</li>
                                                            <li>• Expense Multiplier: {(data.swpPlan.inflationAdjustedMonthlyExpenses / data.swpPlan.currentMonthlyExpenses).toFixed(2)}x</li>
                                                            <li>• Total Outflow at Start: ₹{data.swpPlan.totalInflationAdjustedOutflow.toLocaleString()}</li>
                                                            <li>• Purchasing Power Loss: {(100 - (data.swpPlan.currentMonthlyExpenses / data.swpPlan.inflationAdjustedMonthlyExpenses * 100)).toFixed(1)}%</li>
                                                        </ul>
                                                    </div>
                                                </div>

                                                {/* Active Liabilities Breakdown */}
                                                {data.swpPlan.activeLiabilitiesAtSwpStart.length > 0 && (
                                                    <div className="mt-3">
                                                        <h6 className="text-danger">Loans Active During SWP Period</h6>
                                                        <div className="alert alert-warning">
                                                            <p className="mb-2"><strong>Important:</strong> These loans are currently funded by your income. 
                                                            After retirement, they will need to be funded from your SWP corpus.</p>
                                                            
                                                            {data.swpPlan.activeLiabilitiesAtSwpStart.map((liability, index) => (
                                                                <div key={index} className="border-start border-3 border-danger ps-3 mb-2">
                                                                    <strong>{liability.name}</strong><br/>
                                                                    <small>
                                                                        EMI: ₹{liability.emi.toLocaleString()}/month | 
                                                                        Remaining: {liability.remainingYears} years from SWP start | 
                                                                        Total from corpus: ₹{(liability.emi * liability.remainingYears * 12).toLocaleString()}
                                                                    </small>
                                                                </div>
                                                            ))}
                                                            
                                                            <div className="mt-2 p-2 bg-light rounded">
                                                                <strong>Total EMI Impact on Corpus:</strong> ₹{(data.swpPlan.monthlyEMIAtSwpStart * 
                                                                data.swpPlan.activeLiabilitiesAtSwpStart.reduce((total, liability) => 
                                                                total + liability.remainingYears, 0) * 12).toLocaleString()}
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}

                                                {data.swpPlan.sustainabilityYears >= 25 && (
                                                    <div className="alert alert-success">
                                                        <strong><i className="fas fa-check-circle me-2"></i>Excellent Planning!</strong> 
                                                        Your investments can sustain inflation-adjusted expenses for over 25 years. 
                                                        You're well-prepared for retirement even with inflation impact.
                                                    </div>
                                                )}
                                                {data.swpPlan.sustainabilityYears >= 15 && data.swpPlan.sustainabilityYears < 25 && (
                                                    <div className="alert alert-info">
                                                        <strong><i className="fas fa-info-circle me-2"></i>Good Foundation!</strong> 
                                                        Your plan sustains for {data.swpPlan.sustainabilityYears.toFixed(1)} years with inflation. 
                                                        Consider increasing investments by 20-30% for better long-term security.
                                                    </div>
                                                )}
                                                {data.swpPlan.sustainabilityYears >= 10 && data.swpPlan.sustainabilityYears < 15 && (
                                                    <div className="alert alert-warning">
                                                        <strong><i className="fas fa-exclamation-triangle me-2"></i>Needs Improvement!</strong> 
                                                        Inflation significantly impacts your plan. Consider increasing monthly investments 
                                                        by 50% or reducing post-retirement expenses to improve sustainability.
                                                    </div>
                                                )}
                                                {data.swpPlan.sustainabilityYears < 10 && (
                                                    <div className="alert alert-danger">
                                                        <strong><i className="fas fa-times-circle me-2"></i>Critical Situation!</strong> 
                                                        Your current plan cannot sustain inflation-adjusted expenses for even 10 years. 
                                                        Immediate action needed: double your investments or significantly reduce expenses.
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<WealthPlanApp />, document.getElementById('root'));
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9717668895d2320c',t:'MTc1NTU4MjkxMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
